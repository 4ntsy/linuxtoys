## linuxtoys function library
source /etc/os-release

# sudo request
sudo_rq () { 
    # Get password from zenity
    local password
    if ! password=$(zenity --password 2>/dev/null); then
        fatal "Password dialog was cancelled or failed."
    fi
    # Validate password with sudo
    if echo "$password" | timeout 5 sudo -S -p "" true 2>/dev/null; then
        # Keep sudo session alive for a bit
        sudo -v 2>/dev/null
        unset password
        return 0
    else
        unset password
        fatal "Wrong password. Do you have sudo?"
    fi
}

# zenity libs
zeninf () {
    zenity --info --text "$1" --width 360 --height 300
    return 0
}
zenwrn () {
    zenity --warning --text "$1" --width 360 --height 300
    return 0
}

## error handlers
fatal() {
    zenity --error --title "Fatal Error" --text "$1" --width 360 --height 300
    exit 1
}
nonfatal() {
    zenity --error --title "Error" --text "$1" --width 360 --height 300
    return 1
}

# native package installation
_install_ () {
    if [[ -n "$_packages" ]]; then
        # rpm-ostree iteration -- ONLY USE WHEN PACKAGES ARE NOT IMPORTANT TO THE SYSTEM!
        if command -v rpm-ostree &>/dev/null; then
            declare -a _to_install=()
            for pkg in "${_packages[@]}"; do
                if ! rpm -qi "$pkg" &>/dev/null; then
                    _to_install+=("$pkg")
                fi
            done
            if [[ -n "$_to_install" ]]; then
                sudo rpm-ostree install -yA "${_to_install[@]}"
            else
                return 0
            fi
        else
        # resume usual linuxtoys behaviour
            if [[ "$ID_LIKE" == *debian* ]] || [[ "$ID_LIKE" == *ubuntu* ]] || [ "$ID" == "debian" ] || [ "$ID" == "ubuntu" ]; then
                for pak in "${_packages[@]}"; do
                    if dpkg -s "$pak" 2>/dev/null 1>&2; then
                        continue
                    else
                        sudo apt install -y "$pak"
                    fi
                done
            elif [[ "$ID" =~ ^(arch|cachyos)$ ]] || [[ "$ID_LIKE" == *arch* ]] || [[ "$ID_LIKE" == *archlinux* ]]; then
                for pak in "${_packages[@]}"; do
                    if pacman -Qi "$pak" 2>/dev/null 1>&2; then
                        continue
                    else
                        sudo pacman -S --noconfirm "$pak"
                    fi
                done
            elif [[ "$ID_LIKE" =~ (rhel|fedora) ]] || [[ "$ID" =~ (fedora) ]]; then
                for pak in "${_packages[@]}"; do
                    if rpm -qi "$pak" 2>/dev/null 1>&2; then
                        continue
                    else
                        sudo dnf in "$pak" -y
                    fi
                done
            elif [[ "$ID_LIKE" == *suse* ]] || [[ "$ID" == *suse* ]]; then
                for pak in "${_packages[@]}"; do
                    if rpm -qi "$pak" 2>/dev/null 1>&2; then
                        continue
                    else
                        sudo zypper in "$pak" -y
                    fi
                done
            fi
        fi
        unset _packages
    fi
}

# flatpak installer
_flatpak_ () {
    if [[ -n "$_flatpaks" ]]; then
        for flat in "${_flatpaks[@]}"; do
            flatpak install --or-update --user --noninteractive flathub "$flat"
        done
        unset _flatpaks
    fi
}

# language detect -- add elif for each language in the last if statement
_lang_ () {
    local lang="${LANG:0:2}"
    local available=("pt")
    local ulang=""
    langfile=""

    if [[ " ${available[*]} " == *"$lang"* ]]; then
        ulang="$lang"
    else
        ulang="en"
    fi
    if [ $ulang == "pt" ]; then
        langfile="pt"
    else
        langfile="en"
    fi
}

# docker compose up
_docker_up() {
	_docker_dir="${HOME}/.local/linuxtoys/docker/"

	[ ! -z "${1}" -a -f "${1}" ] || { exit; }

	_service=${1##*/}; _service="${_service%%.*}";

	mkdir -p "${_docker_dir}/${_service}"

	_env="${_docker_dir}/${_service}/.env"

	type -p docker || { fatal "You need docker before run this script."; exit -1; }

	[ -f "${_env}" ] && {
		_config_path="$(realpath "${1}")"

		sudo docker ps --format {{.Labels}} --filter "status=running" \
			| grep -Pio '(?<=config_files=)[^,]*' | sort -u \
			| grep -q "^${_config_path}$" && {
			zenity --title="Docker Compose" --question --text="Service is already running." --ok-label="Stop" --cancel-label="Cancel" && {
				sudo docker compose -f "${1}" --env-file "${_env}" down && { zeninf "$msg018"; exit 0; }
			} || { exit 0; }
		}
		zenity --title="Docker Compose" --question --text="Run service or Create a New" --ok-label="Run" --cancel-label="Create" && {
			sudo docker compose -f "${1}" --env-file "${_env}" up -d && { zeninf "$msg018"; exit 0; }
		}
	} || {
		_vars=($(grep -oP '(?<=\${)[A-Za-z0-9_]*' "${1}" | awk '!seen[$0]++'))

		_entries=()

		for _v in ${_vars[@]}; do _entries+=("--add-entry="${_v}" ");done

		_sets=($(zenity --forms --title="Docker Compose" --separator=" " --text="Fill in all fields" ${_entries[@]}))

		[ ${#_sets[@]} -eq ${#_vars[@]} ] || { fatal "All fields are required"; exit -1; }

		> "${_env}"

		for i in ${!_sets[@]};do echo "${_vars[i]}"="${_sets[i]}" >> "${_env}";done

		sudo docker compose -f "${1}" --env-file "${_env}" up -d && { zeninf "$msg018"; exit 0; }
	}
}